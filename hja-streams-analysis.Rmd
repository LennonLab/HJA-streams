---
title: Bacterial community assembly differs between benthic and planktonic stream
  habitats
author: "Nathan I. Wisnoski and Jay T. Lennon"
date: "2019-01-04"
output: pdf_document
---

# Initial setup 
```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE, 
  fig.align = "center", 
  fig.width = 6,
  message = FALSE,
  warning = FALSE
)

library("vegan")
library("adespatial")
library("pander")
library("stringr")
library("picante")
library("phytools")
library("GUniFrac")
library("gdm")
library("tidyverse")
library("cowplot")
library("ggrepel")

theme_set(theme_cowplot() +
            theme(axis.title = element_text(size = 12),
                  axis.text = element_text(size = 10),
                  legend.position = "top", 
                  strip.text = element_text(size = 12),
                  strip.background = element_blank(),
                  legend.text = element_text(size = 10),
                  legend.title = element_text(size = 12)))

# used https://www.color-hex.com/color-palette/71977
my.colors <- c("#d5ba94", "#3a4f6a")

# load external functions
source("analysis/mothur_tools.R")
source("analysis/hja_functions.R")
```

First, we load the data. This includes the site-by-species matrix (generated in Mothur, v. 1.41.1), the RDP taxonomy, the environmental data, and the phylogenetic tree (generated with FastTreeMP).
```{r load, echo=FALSE, message=FALSE}
## Import Shared, Design, and Environment Files

# Define Inputs
# Design = general design file for experiment
# shared = OTU table from mothur with sequence similarity clustering
# Taxonomy = Taxonomic information for each OTU

# Import Design
design.total <- read.delim("data/design.txt", header=T, row.names=1)

# Import Shared Files
OTUs <- read.otu(shared = "data/hja_streams.shared", cutoff = "0.03") # 97% Similarity

# Import Taxonomy
OTU.tax <- read.tax(taxonomy = "data/hja_streams.0.03.taxonomy", format = "rdp")

# Import Env
env.total <- read_csv("data/hja_env.csv", 
                      col_types = cols(
                        date = col_date(format = "%d-%b-%y"),
                        habitat = col_factor(levels = c("sediment", "water"), ordered = F)))

# Check to see that the OTU table rows are same order as design and then rename OTU table rows 
sites <- as.data.frame(str_split(rownames(design.total), "_", simplify = T))
colnames(sites) <- c("ws", "site", "habitat")
oturows <- rownames(OTUs) %>% str_sub(7)
if(all.equal.character(paste0(sites$ws, sites$site, sites$habitat), oturows)){
  rownames(OTUs) <- rownames(design.total)
}
```

Next, we will clean up the data. I'll remove any sample that didn't get 10000 reads. Then also cut those samples from the environment and design tables.
```{r cleanup}
# Sequencing Coverage
coverage <- rowSums(OTUs)

# Remove Low Coverage Samples
cutoff <- 10000
lows <- which(coverage < cutoff)
OTUs <- OTUs[-which(coverage < cutoff), ]
design <- design.total[-which(coverage < cutoff), ]
env <- env.total[-which(coverage < cutoff), ]

# Remove OTUs with less than 5 occurances across all sites
OTUs <- OTUs[, which(colSums(OTUs) >= 10)]

OTUs <- OTUs[-which(env$sample == "W1_20_W"),]
design <- design[-which(env$sample == "W1_20_W"),]
env <- env[-which(env$sample == "W1_20_W"),]
```

Here, I'll read in the dendritic distances and add a tiny bit of jitter to the spatial distances so nearby sites aren't identical. Then, I'll calculate the earth distance in meters.
```{r dendritic}
den.dists <- make.dendritic.dists("data/hja_dendritic-dists.csv")
design$upstreamdist <- as.matrix(den.dists)[1,]

# Read in Distances
# Geo distance Matrix
xy <- cbind(jitter(env$longitude, amount = .0001),
            jitter(env$latitude, amount = .0001))
geo.dists <- SoDA::geoXY(xy[,1], xy[,2])
#xy <- project(xy, "+proj=utm +zone=10 +ellps=WGS84")
#dist.mat <- as.matrix(dist(xy, method = "euclidean"))
dist.mat <- fossil::earth.dist(xy) * 1000
```

Next, we will see if any of the environmental variables need to be transformed. I'll then rescale the environmental variables.
```{r env_transfom}
# Remove orthogonal vectors and make numbers below detection close to zero
env.subs <- env %>% select(habitat, elevation, 
                           temperature, conductivity, 
                           ph, TN, TP, DOC) %>% 
  mutate(TN = if_else(TN < 0, 0.001, TN),
         TP = if_else(TP < 0, 0.001, TP))

#hist(log(env.subs$TP), breaks = 30)
#hist(log(env.subs$TN), breaks = 30)

env.subs <- env.subs %>% mutate(TN = log(TN), TP = log(TP))

# rescale variables
env.subs <- env.subs %>% mutate_if(is_double, scale_vec)
```

Now, I'll perform some transformations on the abundance data. I'll work with the Hellinger-transformed data for the rest of the analysis.
```{r abund_transform}
# Rarefy communities
set.seed(47405)
OTUs <- rrarefy(OTUs, min(rowSums(OTUs)))
OTUs <- OTUs[,-which(colSums(OTUs) == 0)]
# saveRDS(OTUs, file = "temp/site_by_species_rarefied.rda")
# OTUs <- readRDS("temp/site_by_species_rarefied.rda")

# Transformations and Standardizations
OTUsREL <- decostand(OTUs, method = "total")
OTUs.PA <- decostand(OTUs, method = "pa")
OTUsREL.log <- decostand(OTUs, method = "log")
OTUsREL.hel <- decostand(OTUs, method = "hellinger")
```
I removed the sites with low coverage, and I removed the OTUs with low abundance across the whole dataset. This left a total of `r nrow(OTUs)` sites and `r ncol(OTUs)` bacterial taxa. 

Here, we will read in the phylogenetic tree, root it, and create the unifract distance matrices. I pruned the phylogenetic tree to match only the taxa remaining in the dataset. Then, I rooted the tree using the midpoint method and computed generalized UniFrac distances with a scaling factor of 0.5, along with unweighted and weighted calculations. 
```{r tree, message=FALSE}
# hja.tree <- read.tree("data/hja_streams.tree")
# matched.phylo <- match.phylo.comm(hja.tree, OTUs)
# hja.tree <- matched.phylo$phy
# is.rooted(hja.tree)
# hja.tree.rooted <- midpoint.root(hja.tree)
# is.rooted(hja.tree.rooted)
# saveRDS(object = hja.tree.rooted, file = "temp/hja_tree_rooted.nwk")
# hja.tree.rooted <- readRDS(file = "temp/hja_tree_rooted.nwk")

# hja.unifrac <- GUniFrac(otu.tab = OTUs, tree = hja.tree.rooted)$unifracs
# saveRDS(hja.unifrac, file = "temp/hja_unifrac.rda")
hja.unifrac <- readRDS(file = "temp/hja_unifrac.rda")
hja.unifrac.dw <- as.dist(hja.unifrac[,,"d_1"])		  # Weighted UniFrac
hja.unifrac.du <- as.dist(hja.unifrac[,,"d_UW"])		  # Unweighted UniFrac	
hja.unifrac.dv <- as.dist(hja.unifrac[,,"d_VAW"])		# Variance adjusted weighted UniFrac
hja.unifrac.d0 <- as.dist(hja.unifrac[,,"d_0"])    	# GUniFrac with alpha 0  
hja.unifrac.d5 <- as.dist(hja.unifrac[,,"d_0.5"])   	# GUniFrac with alpha 0.5 
```


# Environmental analysis
Here, I'll just plot the environmental variables from downstream to upstream across the watershed.
```{r envplots, fig.asp=(1/.618)}
env.subs %>% mutate(upstreamdist = design$upstreamdist, watershed = design$watershed) %>% 
  gather(-upstreamdist, -watershed, -habitat, key = variable, value = measurement) %>% 
  ggplot(aes(x = upstreamdist, y = measurement, color = watershed)) + 
  facet_grid(variable ~ watershed, scales = "free_x") + 
  geom_point() +
  geom_smooth() + 
  theme(legend.position = "top") +
  scale_x_continuous(labels = scales::wrap_format(10)) + 
  labs(x = "Upstream distance (m)", 
       y = "Value (z-score)",
       color = "Watershed")
```

# \alpha-Diversity analysis
```{r fig_alpha}
alpha.tbl <- tibble(
  habitat = str_to_title(design$habitat),
  upstream = design$upstreamdist,
  N0 = rowSums(OTUsREL.hel > 0),
  N1 = exp(diversity(OTUsREL.hel, index = "shannon")),
  N2 = diversity(OTUsREL, index = "invsimpson")
)

alpha.fig <- alpha.tbl %>% 
  ggplot(aes(x = habitat, y = N1, fill = habitat)) +
  geom_boxplot(color = "gray50") +
  labs(x = "", y = expression(paste(alpha, "-diversity (species equivalents)"))) +
  scale_fill_manual(values = (my.colors)) +
  guides(fill = FALSE) +
  scale_y_continuous(limits = c(0, 3500)) +
  ggsave("figures/alpha_diversity.png", width = 84, height = 84*1.618, units = "mm", dpi = 500) +
  ggsave("figures/alpha_diversity.pdf", width = 84, height = 84*1.618, units = "mm")
```

## Unique taxa per habitat
```{r}
sediment.only <- OTUs[, which(
  colSums(OTUs[which(design$habitat == "water"),]) == 0)]
water.only <- OTUs[, which(
  colSums(OTUs[which(design$habitat == "sediment"),]) == 0)]
water.sed <- OTUs[, which(
  colSums(OTUs[which(design$habitat == "sediment"),]) > 1 & 
  colSums(OTUs[which(design$habitat == "water"),]) > 1)]
in.water <- OTUs[, which(
  colSums(OTUs[which(design$habitat == "water"),]) > 1)]
in.water.pa <- decostand(in.water, method = "pa")
in.sediment <- OTUs[, which(
  colSums(OTUs[which(design$habitat == "sediment"),]) > 1)]
in.sediment.pa <- decostand(in.sediment, method = "pa")


# what proportion of taxa are unique at each site
water.richness <- rowSums(in.water.pa[which(design$habitat == "water"),])
# in water samples, but not in any sediments
water.unique <- rowSums(in.water.pa[ 
  which(design$habitat == "water"), # count the number of taxa in each water samp 
  which(colSums(in.water.pa[which(design$habitat == "sediment"),]) == 0)]) # whose abund in sediments is zero
water.unique.frac <- water.unique / water.richness
se(water.unique.frac)

sed.richness <- rowSums(in.sediment.pa[which(design$habitat == "sediment"),])
# in sediments, but not in any water samples
sed.unique <- rowSums(in.sediment.pa[
  which(design$habitat == "sediment"), # count number of taxa in sed samples
  which(colSums(in.sediment.pa[which(design$habitat == "water"),]) == 0)]) #whose abund in water is zero
sed.unique.frac <- sed.unique / sed.richness
se(sed.frac)

unique.fracs <- data.frame("unique_frac" = water.unique.frac, 
                           "habitat" = "water") %>% 
  rbind.data.frame(., data.frame(
    "unique_frac" = sed.unique.frac, 
    "habitat" = "sediment"))
unique.fracs$habitat <- factor(unique.fracs$habitat, 
                               levels = c("sediment", "water"), ordered = F)
summary(lm(unique_frac ~ habitat, data = unique.fracs))
summary(lm(unique_frac ~ habitat, data = unique.fracs)) %>% 
  capture.output(file = "tables/unique_compare.txt")
```

```{r unique_taxa_figure}
unique.fig <- unique.fracs %>% 
  ggplot(aes(x = str_to_title(habitat), y = unique_frac, fill = habitat)) + 
  geom_boxplot(color = "gray50") +
  labs(x = "", y = "Unique taxa (richness)") +
  scale_fill_manual(values = (my.colors)) +
  guides(fill = FALSE) +
  scale_y_continuous(limits = c(0, .3)) +
  ggsave("figures/unique_taxa.png", width = 84, height = 84*1.618, units = "mm", dpi = 500) +
  ggsave("figures/unique_taxa.pdf", width = 84, height = 84*1.618, units = "mm")
```

```{r fig1}
cowplot::plot_grid(alpha.fig + theme(axis.text.x = element_blank()),
                   unique.fig, align = "hv", labels = c("(a)", "(b)"), nrow = 2) +
  ggsave("figures/Fig1.png", width = 84, height = 2*84*1.618, units = "mm", dpi = 500)
```


# Beta diversity: 
### Ordination
```{r run_pcoa, fig.show='hide'}
hja.pcoa <- run.pcoa(comm = OTUsREL.hel, dist.metric = "euclidean", plot = T)
pcoa.ellipse <- ordiellipse(hja.pcoa$pcoa, str_to_title(design$habitat), display = "sites",
            kind = "se", conf = 0.95, label = T)
pcoa.plot <- cbind.data.frame(scores(hja.pcoa$pcoa), group = str_to_title(design$habitat))
df_ell <- calc.ellipse(ord = pcoa.plot, ellipse = pcoa.ellipse)


# Run a PERMANOVA
hja.permanova <- adonis(hja.pcoa$dist.matrix ~ design$habitat * design$order, permutations = 999)
hja.permanova$aov.tab %>% pander::pander()
capture.output(hja.permanova$aov.tab, file = "./tables/hja_permanova.txt")
```

```{r fig_pcoa}
ggplot(data = pcoa.plot, aes(Dim1, Dim2)) +
  geom_hline(aes(yintercept = 0), linetype = "dashed", alpha = 0.25, size = 0.25) +
  geom_vline(aes(xintercept = 0), linetype = "dashed", alpha = 0.25, size = 0.25) +
  geom_point(aes(color = group, shape = group), size = 2, alpha = .8) +
  geom_point(data = subset(pcoa.plot, group == "Sediment"), shape = 1, color = "black", size = 2) +
  geom_point(data = subset(pcoa.plot, group == "Water"), shape = 2, color = "black", size = 2) +
  # geom_path(data = df_ell, 
  #           aes(x = Dim1, y = Dim2, color = group),
  #           size = .8, alpha = 1, linetype = 2) +
  labs(x = paste0("PCoA1 (", hja.pcoa$var1, "%)"),
    y = paste0("PCoA2 (", hja.pcoa$var2, "%)"),
    color = "Habitat", shape = "Habitat") +
  scale_color_manual(values = my.colors) + 
  coord_fixed() +
  theme(legend.position = "none") + 
  annotate("text", x = .3, y = -.25, label = "Sediment", size = 3) +
  annotate("text", x = -.27, y = -.22, label = "Plankton", size = 3) +
  ggsave("figures/PCoA.png", width = 84, height = 84, units = "mm", dpi = 500)
```

Now, we'll run an RDA. 
```{r dbrda, cache=TRUE}
hja.rda <- rda(OTUsREL.hel ~ ., env.subs)
R2.all.vars <- RsquareAdj(hja.rda)$adj.r.squared
#anova(hja.rda, permutations = how(nperm = 999))
#anova(hja.rda, by = "axis", permutations = how(nperm = 999))
```
We see that the RDA is globally significant and the first two canonical axes are also significant. Because the full model was significant, I'll run a model selection procedure.

```{r}
forward.sel(OTUsREL.hel, 
            model.matrix(~., env.subs)[,-1],
            adjR2thresh = R2.all.vars,
            nperm = 999)

# habitat, elevation, and conductivity were selected by Blanchet 2008 method

hja.rda.reduced <- rda(OTUsREL.hel ~ habitat + elevation + conductivity, env.subs)
```
The model selection procedure left us with the model using only habitat, elevation, and conductivity as predictor variables. Now, we have 3 significant RDA axes with the more parsimonious model. 

```{r}
rda.plot <- cbind.data.frame(scores(hja.rda.reduced)$sites, group = str_to_title(design$habitat))
rda.var1 <- round(eigenvals(hja.rda.reduced)[1] / sum(eigenvals(hja.rda.reduced)) * 100, 2)
rda.var2 <- round(eigenvals(hja.rda.reduced)[2] / sum(eigenvals(hja.rda.reduced)) * 100, 2)
rda.vecs <- as.data.frame(hja.rda.reduced$CCA$biplot)
rda.vecs$predictor <- c("Planktonic\n habitat", "Elevation", "Conductivity")
rda.vecs$origin <- 0
scale.arrows = .5
ggplot(data = rda.plot, aes(RDA1, RDA2)) +
  geom_hline(aes(yintercept = 0), linetype = "dashed", alpha = 0.25, size = 0.25) +
  geom_vline(aes(xintercept = 0), linetype = "dashed", alpha = 0.25, size = 0.25) +
  geom_point(aes(color = group, shape = group), size = 2, alpha = .8) +
  geom_point(data = subset(rda.plot, group == "Sediment"), shape = 1, color = "black", size = 2) +
  geom_point(data = subset(rda.plot, group == "Water"), shape = 2, color = "black", size = 2) +
  # geom_path(data = df_ell, 
  #           aes(x = Dim1, y = Dim2, color = group),
  #           size = .8, alpha = 1, linetype = 2) +
  labs(x = paste0("RDA1 (", rda.var1, "%)"),
    y = paste0("RDA2 (", rda.var2, "%)"),
    color = "Habitat", shape = "Habitat") +
  scale_color_manual(values = my.colors) + 
  coord_fixed() +
  theme(legend.position = "none") + 
  geom_segment(data = rda.vecs, size = .5,
               aes(x = origin, y = origin, 
                   xend = scale.arrows*RDA1, 
                   yend = scale.arrows*RDA2),
               alpha = 1, color = "black",
               arrow = arrow(angle = 20,
                             length = unit(.1, "inches"),
                             type = "open")) +
  geom_text_repel(data = rda.vecs, size = 3,
                   aes(x = (scale.arrows + .1)*RDA1, 
                       y = (scale.arrows + .1)*RDA2, label = predictor),
                   color = "black",
                   segment.alpha = 0, 
                  point.padding = 0, nudge_y = c(-.1, 0, 0)) +
  #annotate("text", x = .3, y = -.25, label = "Sediment", size = 3) +
  #annotate("text", x = -.27, y = -.22, label = "Plankton", size = 3) +
  ggsave("figures/RDA.png", width = 84, height = 84, units = "mm", dpi = 500)
```


### LCBD and SCBD
Now, I'm going calculate the total beta diversity in the samples, and calcluate the local contributions to beta diversity (LCBD) and species contributions to beta diversity (SCBD). LCBD may be highest in more isolated reaches of the stream network
```{r calc_LCBD, cache=TRUE}
otu.beta <- beta.div(OTUs, method = "hellinger", nperm = 9999)
saveRDS(otu.beta, file = "temp/lcbd.rda")
```

```{r fig_LCBD}
otu.beta$beta # max is 1

# which taxa contribute most to beta diversity?
OTU.tax[order(otu.beta$SCBD[otu.beta$SCBD > mean(otu.beta$SCBD)], 
              decreasing = T)[1:10],-c(1,2)] %>% 
  remove_rownames() %>% pander()

row.names(OTUs[which(otu.beta$p.adj <= 0.05),])
design[which(otu.beta$p.adj <= 0.05),]
beta.tbl <- cbind.data.frame(
  design,
  LCBD = otu.beta$LCBD,
  pval = otu.beta$p.adj)
beta.tbl %>% 
  ggplot(aes(x = upstreamdist, y = LCBD, color = habitat, fill = habitat)) +
  geom_point(alpha = 0.5, size = 3) +
  geom_smooth(method = "loess", span = 1, se = F) + 
  #geom_smooth(method = "lm", formula = y ~ x + I(x^2), se = F) +
  scale_x_continuous(labels = scales::comma) +
  labs(x = "Upstream distance (m)", color = "Habitat", fill = "Habitat") +
  scale_color_manual(values = my.colors) + 
  scale_fill_manual(values = my.colors) +
  facet_wrap(~ watershed, ncol = 2, scales = "free_x") +
  ggsave("figures/LCBD.png", height = 4, width = 4*1.618, dpi = 500)
  
```
We observed \(BD_{total} = `r round(otu.beta$beta[2], 3)`\) out of 1. We also find spatial structure in the site contributions to beta diversity. We find that, in the smaller watershed (WS01), greater distance upstream into the watershed uncovered more unique taxa. Downstream sites contributed less overall to beta diversity in the catchment. This pattern was observed in both sediment and planktonic communities. At the larger scale of the entire catchment, however, this pattern is not consistent. We found higher overal local contributions to beta diversity for sites across the large scale (indicating that they contained more unique taxa overall). We observed a similar increasing trend in the sediment community showing an increased contribution of headwaters to beta diversity, but a similar pattern was not found for planktonic communities on the catchment scale. This suggests that (1) within a small watershed, sites located a greater distance upstream contain more regionally unique taxa than sites located downstream, but (2) when considered at the regional scale, planktonic communities are  more unique across lower to intermediate distances upstream (e.g., due do localized immigration from nearby soils), but with in 

```{r}


```

\newpage
# Appendix: Session Info
```{r}
sessionInfo()
```

