---
title: "Analysis for Stream Microbial Metacommunity"
output: pdf_document
---

# Initial Setup & Load Data
```{r}
# Initial setup
rm(list=ls())
opar <- par()
setwd("./analysis")

# Check for and install required packages
package.list <- c('vegan', 'png', 'simba', 'grid', 
                  'vegetarian', 'pander', 'SoDA', 'fossil',
                  'tidyverse')
for (package in package.list) {
  if (!require(package, character.only=T, quietly=T)) {
    install.packages(package)
    library(package, character.only=T)
  }
}

# Load Data
OTUs <- readRDS(file = "./data/SiteBySpecies.rda")
env <- readRDS(file = "./data/SiteByEnv.rda")
OTU.tax <- readRDS(file = "./data/Taxonomy.rda")
design <- readRDS(file = "./data/SiteDesign.rda")

# Load functions
source("HJA-Functions.R")
```

## Data transformations and Distance matrices
```{r}
transformation <- "hellinger"

# Make Standardized Matrix
OTUsREL <- decostand(OTUs, method = transformation)

# Create Geographic Distance Matrix
xy <- cbind(env$longitude, env$latitude)
dist.mat <- fossil::earth.dist(xy) * 1000

```

## Diversity Analysis
```{r}
comms <- resample.comms(comm = OTUs, n = 10, transformation = transformation)

alpha.div <- for(i in 1:dim(comms)[3]){
  alpha.div[i] <- diversity(comms[,,i], method = "shannon")}
alpha.div.exp <- lapply(alpha.div, FUN = exp)


```

### Figure 1: Rarefied diversity in sediment and surface-water communities
```{r fig.width=4, fig.height=4,echo=FALSE,fig.cap="Higher richness in surface water than in sediments."}
img <- readPNG("../figures/AlphaDiv.png")
grid.raster(img)
```


### Figure 3: Beta-diversity is higher among headwaters than among higher order streams.
```{r fig.width=4, fig.height=4,echo=FALSE,fig.cap="Microbial Commuinity Shifts"}
img <- readPNG("../figures/BetaDivByOrder.png")
grid.raster(img)
```

### Ordination
```{r}
source("./Ordination.R", echo = TRUE)
```

#### Figure 4: Sediments & Water Communities PCoA
```{r fig.width=4, fig.height=4,echo=FALSE,fig.cap="Ordination across the HJ Andrews Catchment"}
img <- readPNG("../figures/HJA_PCoA.png")
grid.raster(img)
```


### Identify Unique OTUs across habitats
```{r}
source("./UniqueTaxa.R", echo = TRUE)
```

### Figure 5: Proportion unique taxa
```{r fig.width=4, fig.height=4,echo=FALSE,fig.cap="Surface waters house more unique taxa than sediments do."}
img <- readPNG("../figures/UniqueTaxa.png")
grid.raster(img)
```

# Distance Decay Relationships
```{r}
source("./DistanceCalcs.R", echo = T)
source("./DDRs.R", echo = T)
```

## Figure: Sed vs Water DDRs
```{r fig.width=4, fig.height=4,echo=FALSE,fig.cap="Distance-decay relationship."}
img <- readPNG("../figures/DDR_WaterSed.png")
grid.raster(img)
```

# Figure: Headwaters vs Mainstem DDRs 
```{r fig.width=4, fig.height=4,echo=FALSE,fig.cap="Beta-diversity in surface waters and sediments by elevation."}
img <- readPNG("../figures/DDR_HeadwaterMainstem.png")
grid.raster(img)
```








