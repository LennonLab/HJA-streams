---
title: "Stream microbial metacommunities"
author: "Wisnoski; Lennon"
date: "June 15, 2016"
output: pdf_document
---

### Initial Setup
```{r}
rm(list=ls())
setwd("~/GitHub/HJA-streams/analysis")
opar <- par()
```

### Import Source Files and Packages
```{r}
source("MothurTools.R")

require("vegan")
require("png")
require("raster")
require("sp")
require("rgdal")
require("SoDA")
require("grid")
require("simba")
require("vegetarian")

se <- function(x, ...){sd(x, na.rm = TRUE)/sqrt(length(na.omit(x)))}

error.bar <- function(x, y, upper, lower=upper, length=0.1,...){
  if(length(x) != length(y) | length(y) !=length(lower) | length(lower) != length(upper))
    stop("vectors must be same length")
  arrows(x,y+upper, x, y-lower, angle=90, code=3, length=length, ...)
}

```


### Import Shared, Design, and Environment Files
```{r}
# Define Inputs
# Design = general design file for experiment
# shared = OTU table from mothur with sequence similarity clustering
# Taxonomy = Taxonomic information for each OTU
design <- "../data/design.txt"
shared <- "../data/hja_streams.final.shared"
taxon  <- "../data/hja_streams.final.0.03.taxonomy"
env    <- "../data/hja_env.csv"

# Import Design
design.total <- read.delim(design, header=T, row.names=1)

# Import Shared Files
OTUs <- read.otu(shared = shared, cutoff = "0.03")         # 97% Similarity

# Import Taxonomy
OTU.tax <- read.tax(taxonomy = taxon, format = "rdp")

# Import Env
env.total <- read.csv(env, header=T)

```

### Data Transformations
```{r}
# Remove OTUs with less than two occurances across all sites
OTUs <- OTUs[, which(colSums(OTUs) >= 2)]

# Sequencing an Good's Coverage
# Sequencing Coverage
coverage <- rowSums(OTUs)

# Good's Coverage
goods <- function(x = ""){
  1 - (sum(x == 1) / rowSums(x))
}
goods.c <- goods(OTUs)

# Remove Low Coverage Samples
lows <- which(coverage < 7000)
lows
OTUs <- OTUs[-which(coverage < 7000), ]
design <- design.total[-which(coverage < 7000), ]
env <- env.total[-which(coverage < 7000), ]

# Remove orthogonal vectors
env <- env[c(1:11, 13, 16, 18, 19)]
env.mat <- as.matrix(env[10:15])
env.mat[51,5] <- 150
env.mat[52,5] <- 150
for(i in 1:nrow(env.mat)){
  if(env.mat[i, 5] < 0){
    env.mat[i, 5] <- 0.0001
  }
  if(env.mat[i, 6] < 0){
    env.mat[i, 6] <- 0.0001
  }
}
env.mat <- scale(env.mat)

# Make Relative Abundence Matrices
OTUsREL <- decostand(OTUs, method = "total")

# Transform Relative Abundances
OTUsREL.log <- decostand(OTUs, method = "log")

OTUsREL.hel <- decostand(OTUs, method = "hellinger")

OTUs.PA <- decostand(OTUs, method = "pa")

```

# Are bacterioplankton communities more diverse than sediment-associated bacterial communities?

### Calculate Alpha Diversity
```{r}
# Observed Richness
S.obs <- rowSums((OTUs > 0) * 1)

# Simpson's Evenness
SimpE <- function(x = ""){
  x <- as.data.frame(x)
  D <- vegan::diversity(x, "inv")
  S <- sum((x > 0) * 1) 
  E <- (D)/S 
  return(E)
}
simpsE <- round(apply(OTUsREL.hel, 1, SimpE), 3)

shan <- vegan::diversity(OTUsREL.hel, index = "shannon")
simpsD <- vegan::diversity(OTUsREL.hel, index = "invsimpson")

# Rarefaction
hja.S <- rowSums((OTUs > 0) * 1)
min.N <- min(rowSums(OTUs))
S.rarefy <- rarefy(x = OTUs, sample = (min.N), se = TRUE)
rare.d <- t(S.rarefy)
colnames(rare.d) <- c("S.rare", "se.rare")


alpha.div <- cbind(design, S.obs, simpsE, shan, simpsD, rare.d)
```

### Calculate Numbers Equivalents
```{r}
# Catchment Scale
hja.s.size <- as.vector(c(rowSums(OTUsREL.hel)))
hja.alpha <- d(OTUsREL.hel, lev = "alpha", q = 1, boot = T, 
               boot.arg = list(s.sizes = hja.s.size))
hja.beta <- d(OTUsREL.hel, lev = "beta", q = 1, boot = T, 
              boot.arg = list(s.sizes = hja.s.size))
hja.gamma <- d(OTUsREL.hel, lev = "gamma", q = 1, boot = T, 
               boot.arg = list(s.sizes = hja.s.size))


# Small Watershed Scale
ws1.s.size <- as.vector(c(rowSums(OTUsREL.hel[which(design$watershed == "WS01"),])))
ws1.alpha <- d(OTUsREL.hel[which(design$watershed == "WS01"),], lev = "alpha", q = 1, boot = T, 
               boot.arg = list(s.sizes = ws1.s.size))
ws1.beta <- d(OTUsREL.hel[which(design$watershed == "WS01"),], lev = "beta", q = 1, boot = T, 
              boot.arg = list(s.sizes = ws1.s.size))
ws1.gamma <- d(OTUsREL.hel[which(design$watershed == "WS01"),], lev = "gamma", q = 1, boot = T, 
               boot.arg = list(s.sizes = ws1.s.size))


# Water vs. Sediment Comparisons
water.alpha <- d(OTUsREL.hel[which(design$habitat == "water"),], 
                 lev = "alpha", q = 1, boot = T, 
                 boot.arg = list(s.sizes = hja.s.size[which(design$habitat == "water")]))
sediment.alpha <- d(OTUsREL.hel[which(design$habitat == "sediment"),], 
                 lev = "alpha", q = 1, boot = T, 
                 boot.arg = list(s.sizes = hja.s.size[which(design$habitat == "sediment")]))

```

Are bacterioplankton more diverse than sediments?
```{r}
# Richness
alpha.water <- alpha.div[alpha.div$habitat == "water",]
alpha.sed <- alpha.div[alpha.div$habitat == "sediment",]
t.test(alpha.water$S.rare, alpha.sed$S.rare)

# Alpha-Diversity
water.alpha$D.Value / sediment.alpha$D.Value
```

Yes, bacterioplankton are about 1.53 times more diverse than sediment-associated communities. 

# Are bacterioplankton and sediment-associated communities distinct? 

### PCoA
```{r}
# All HJA Catchment
hja.db <- vegdist(OTUsREL.hel, method = "euclidean", upper = TRUE, diag = TRUE)
hja.pcoa <- cmdscale(hja.db, eig=TRUE)
var1 <- round(hja.pcoa$eig[1] / sum(hja.pcoa$eig),3) * 100
var2 <- round(hja.pcoa$eig[2] / sum(hja.pcoa$eig),3) * 100
var3 <- round(hja.pcoa$eig[3] / sum(hja.pcoa$eig),3) * 100
```

#### Figure 1: Sediments vs Water Communities PCoA
```{r}
png(filename = "../figures/Figure1.png",
    width = 1200, height = 1200, res = 96*2)

par(mar = c(5, 5, 3, 2) + 0.1)
plot(hja.pcoa$points[ ,1], hja.pcoa$points[ ,2], 
     ylim = c(-0.5, 0.35), xlim = c(-.5, .5),
     xlab = paste("PCoA 1 (", var1, "%)", sep = ""),
     ylab = paste("PCoA 2 (", var2, "%)", sep = ""), 
     pch = 19, cex = 2.0, type = "n", cex.lab = 1.5, cex.axis = 1.2, axes = F)
axis(side = 1, labels = T, at = c(-0.5,-.25,0,.25,.5), lwd.ticks = 2, cex.axis = 1.2, las = 1)
axis(side = 2, labels = T, lwd.ticks = 2, cex.axis = 1.2, las = 1)
axis(side = 3, labels = F, at = c(-0.5,-.25,0,.25,.5), lwd.ticks = 2, cex.axis = 1.2, las = 1)
axis(side = 4, labels = F, lwd.ticks = 2, cex.axis = 1.2, las = 1)
abline(h = 0, v = 0, lty = 3)
box(lwd = 2)
points(hja.pcoa$points[which(design$habitat == "sediment"),1], 
       hja.pcoa$points[which(design$habitat == "sediment"),2],
       pch=21, cex=2, bg="grey")
points(hja.pcoa$points[which(design$habitat == "water"),1], 
       hja.pcoa$points[which(design$habitat == "water"),2],
       pch=24, cex=2, bg="white")
legend("bottomleft", c("Water", "Sediment"),
         pt.bg = c("white", "grey"), pch = c(24,21), cex = 1.5, bty = "n")

dev.off()
graphics.off()
```

```{r fig.width=4, fig.height=4,echo=FALSE,fig.cap="Ordination across the HJ Andrews Catchment"}
img <- readPNG("../figures/Figure1.png")
grid.raster(img)
```

# Sediments Only
sed <- OTUsREL.hel[which(design$habitat == "sediment"),]
sed.db <- vegdist(sed, method = "euclidean", diag = T)
sed.pcoa <- cmdscale(sed.db, eig=TRUE)
sed.design <- design[which(design$habitat == "sediment"),]
sed.var1 <- round(sed.pcoa$eig[1] / sum(sed.pcoa$eig),3) * 100
sed.var2 <- round(sed.pcoa$eig[2] / sum(sed.pcoa$eig),3) * 100
sed.var3 <- round(sed.pcoa$eig[3] / sum(sed.pcoa$eig),3) * 100

# Water Only
water <- OTUsREL.hel[which(design$habitat == "water"),]
water.db <- vegdist(water, method = "euclidean", diag = T)
water.pcoa <- cmdscale(water.db, eig=TRUE)
water.design <- design[which(design$habitat == "water"),]
water.var1 <- round(water.pcoa$eig[1] / sum(water.pcoa$eig),3) * 100
water.var2 <- round(water.pcoa$eig[2] / sum(water.pcoa$eig),3) * 100
water.var3 <- round(water.pcoa$eig[3] / sum(water.pcoa$eig),3) * 100

# Watershed 01 Only
ws1 <- OTUsREL.hel[which(design$watershed == "WS01"),]
ws1.db <- vegdist(ws1, method = "euclidean", diag = T)
ws1.pcoa <- cmdscale(ws1.db, eig=TRUE)
ws1.design <- design[which(design$watershed == "WS01"),]
ws1.var1 <- round(ws1.pcoa$eig[1] / sum(ws1.pcoa$eig),3) * 100
ws1.var2 <- round(ws1.pcoa$eig[2] / sum(ws1.pcoa$eig),3) * 100
ws1.var3 <- round(ws1.pcoa$eig[3] / sum(ws1.pcoa$eig),3) * 100

sum(sed.pcoa$eig)
sum(water.pcoa$eig)
sum(hja.pcoa$eig)
sum(ws1.pcoa$eig)

# WS01 PCoA
par(mar = c(5, 5, 3, 2) + 0.1)
plot(ws1.pcoa$points[ ,1], ws1.pcoa$points[ ,2],
     xlab = paste("PCoA 1 (", ws1.var1, "%)", sep = ""),
     ylab = paste("PCoA 2 (", ws1.var2, "%)", sep = ""), 
     pch = 16, cex = 2.0, type = "n", cex.lab = 1.5, cex.axis = 1.2, axes = F)
axis(side = 1, labels = T, lwd.ticks = 2, cex.axis = 1.2, las = 1)
axis(side = 2, labels = T, lwd.ticks = 2, cex.axis = 1.2, las = 1)
abline(h = 0, v = 0, lty = 3)
box(lwd = 2)
mtext("Watershed 01", side = 3, line = 2, cex = 1.5)
points(ws1.pcoa$points[which(ws1.design$habitat == "water"),1], 
       ws1.pcoa$points[which(ws1.design$habitat == "water"),2],
       pch=21, cex=2, bg="white")
points(ws1.pcoa$points[which(ws1.design$habitat == "sediment"),1], 
       ws1.pcoa$points[which(ws1.design$habitat == "sediment"),2],
       pch=21, cex=2, bg="grey")

# Sediments
par(mar = c(5, 5, 3, 2) + 0.1)
plot(sed.pcoa$points[ ,1], sed.pcoa$points[ ,2],
     xlab = paste("PCoA 1 (", sed.var1, "%)", sep = ""),
     ylab = paste("PCoA 2 (", sed.var2, "%)", sep = ""), 
     pch = 16, cex = 2.0, type = "n", cex.lab = 1.5, cex.axis = 1.2, axes = F)
axis(side = 1, labels = T, lwd.ticks = 2, cex.axis = 1.2, las = 1)
axis(side = 2, labels = T, lwd.ticks = 2, cex.axis = 1.2, las = 1)
abline(h = 0, v = 0, lty = 3)
box(lwd = 2)
mtext("Sediments", side = 3, line = 2, cex = 1.5)
points(sed.pcoa$points[,1], 
       sed.pcoa$points[,2],
       pch=21, cex=2, bg="grey")
       
# Water 
par(mar = c(5, 5, 3, 2) + 0.1)
plot(water.pcoa$points[ ,1], water.pcoa$points[ ,2],
     xlab = paste("PCoA 1 (", water.var1, "%)", sep = ""),
     ylab = paste("PCoA 2 (", water.var2, "%)", sep = ""), 
     pch = 16, cex = 2.0, type = "n", cex.lab = 1.5, cex.axis = 1.2, axes = F)
axis(side = 1, labels = T, lwd.ticks = 2, cex.axis = 1.2, las = 1)
axis(side = 2, labels = T, lwd.ticks = 2, cex.axis = 1.2, las = 1)
abline(h = 0, v = 0, lty = 3)
box(lwd = 2)
mtext("Bacterioplankton", side = 3, line = 2, cex = 1.5)
points(water.pcoa$points[,1], 
       water.pcoa$points[,2],
       pch=21, cex=2, bg="white")

OTUsREL.hel.std <- apply(OTUsREL.hel, 2, scale)
biplot.pcoa(hja.pcoa, OTUsREL.hel.std)

